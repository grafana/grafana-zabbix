{"version":3,"sources":["../../src/datasource-zabbix/datasource.js"],"names":["bindFunctionDefs","functionDefs","category","aggregationFunctions","_","map","metricFunctions","getCategories","aggFuncDefs","filter","func","includes","def","name","funcInstance","createFuncInstance","params","bindFunction","dataProcessor","getConsolidateBy","target","consolidateBy","funcDef","find","functions","length","downsampleSeries","timeseries_data","options","defaultAgg","consolidateByFunc","timeseries","datapoints","maxDataPoints","groupBy","interval","formatMetric","metricObj","text","expandable","zabbixTemplateFormat","value","utils","escapeRegex","escapedValues","join","zabbixItemIdsTemplateFormat","replaceTemplateVars","templateSrv","scopedVars","replacedTarget","replace","isRegex","sequence","funcsArray","result","i","call","filterEnabledTargets","targets","hide","group","host","item","getTriggerThreshold","expression","thresholdPattern","finded_thresholds","match","threshold","Number","dateMath","migrations","c","responseHandler","ZabbixAPIError","ZabbixAPIDatasource","instanceSettings","alertSrv","dashboardSrv","zabbixAlertingSrv","Zabbix","partial","url","basicAuth","withCredentials","jsonData","username","password","trends","trendsFrom","trendsRange","ttl","cacheTTL","parseInterval","alertingEnabled","alerting","addThresholds","alertingMinSeverity","SEV_WARNING","disableReadOnlyUsersAck","dbConnectionOptions","dbConnection","enableDirectDBConnection","enable","sqlDatasourceId","datasourceId","zabbixOptions","zabbix","alertQuery","then","setPanelAlertState","panelId","alert","state","removeZabbixThreshold","forEach","thresholds","setPanelThreshold","promises","t","timeFrom","Math","ceil","parse","range","from","timeTo","to","cloneDeep","replaceTargetVariables","timeFunctions","time_from","time_to","timeRange","useTrends","isUseTrends","mode","MODE_METRICS","MODE_TEXT","migrate","queryNumericData","queryTextData","MODE_ITEMID","itemids","queryItemIdData","MODE_ITSERVICE","queryITServiceData","MODE_TRIGGERS","queryTriggersData","Promise","all","flatten","data","getItemOptions","itemtype","getItemsFromTarget","queryNumericDataForItems","items","getHistoryPromise","getTrendsDB","dbConnector","handleGrafanaTSResponse","history","valueType","getTrendValueType","getTrend","handleTrends","series","sortBy","point","DATAPOINT_TS","getHistoryDB","getHistory","handleHistory","applyDataProcessingFunctions","trendFunctions","trendValueFunc","transformFunctions","filterFunctions","aliasFunctions","dp","aggFuncNames","lastAgg","findLast","applyTimeShiftFunction","timeShiftFunc","shift","unShiftTimeSeries","resultFormat","handleHistoryAsTable","handleText","resolve","split","itemid","trim","getItemsByIDs","itservice","itServiceFilter","slaProperty","itServiceIds","itServices","isOldVersion","getITServices","itservices","serviceid","getSLA","serviceids","handleSLAResponse","slaResponse","getHostsFromTarget","results","hosts","apps","hostids","appids","minSeverity","triggers","acknowledged","count","getHostAlerts","handleTriggersResponse","zabbixVersion","getVersion","version","login","testSQLDataSource","status","title","message","catch","error","query","parts","each","splitTemplateQuery","part","push","template","zipObject","app","getItems","getApps","getHosts","getGroups","metrics","rangeRaw","annotation","showOkEvents","SHOW_ALL_EVENTS","SHOW_OK_EVENTS","triggersOptions","showTriggers","SHOW_ALL_TRIGGERS","hideHostsInMaintenance","getTriggers","application","triggerName","trigger","buildRegex","test","description","priority","minseverity","objectids","getEvents","indexedTriggers","keyBy","hideAcknowledged","events","event","acknowledges","tags","showHostname","formatted_acknowledges","formatAcknowledges","time","clock","objectid","enabled_targets","getPanelItems","getAlerts","firedTriggers","p","textFilter","param","toString","useTrendsFrom","useTrendsRange","contains","indexBy"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\r\nimport * as dateMath from 'app/core/utils/datemath';\r\nimport * as utils from './utils';\r\nimport * as migrations from './migrations';\r\nimport * as metricFunctions from './metricFunctions';\r\nimport * as c from './constants';\r\nimport dataProcessor from './dataProcessor';\r\nimport responseHandler from './responseHandler';\r\nimport './zabbix.js';\r\nimport './zabbixAlerting.service.js';\r\nimport {ZabbixAPIError} from './zabbixAPICore.service.js';\r\n\r\nclass ZabbixAPIDatasource {\r\n\r\n  /** @ngInject */\r\n  constructor(instanceSettings, templateSrv, alertSrv, dashboardSrv, zabbixAlertingSrv, Zabbix) {\r\n    this.templateSrv = templateSrv;\r\n    this.alertSrv = alertSrv;\r\n    this.dashboardSrv = dashboardSrv;\r\n    this.zabbixAlertingSrv = zabbixAlertingSrv;\r\n\r\n    // Use custom format for template variables\r\n    this.replaceTemplateVars = _.partial(replaceTemplateVars, this.templateSrv);\r\n\r\n    // General data source settings\r\n    this.name             = instanceSettings.name;\r\n    this.url              = instanceSettings.url;\r\n    this.basicAuth        = instanceSettings.basicAuth;\r\n    this.withCredentials  = instanceSettings.withCredentials;\r\n\r\n    const jsonData = instanceSettings.jsonData || {};\r\n\r\n    // Zabbix API credentials\r\n    this.username         = jsonData.username;\r\n    this.password         = jsonData.password;\r\n\r\n    // Use trends instead history since specified time\r\n    this.trends           = jsonData.trends;\r\n    this.trendsFrom       = jsonData.trendsFrom || '7d';\r\n    this.trendsRange      = jsonData.trendsRange || '4d';\r\n\r\n    // Set cache update interval\r\n    var ttl = jsonData.cacheTTL || '1h';\r\n    this.cacheTTL = utils.parseInterval(ttl);\r\n\r\n    // Alerting options\r\n    this.alertingEnabled =     jsonData.alerting;\r\n    this.addThresholds =       jsonData.addThresholds;\r\n    this.alertingMinSeverity = jsonData.alertingMinSeverity || c.SEV_WARNING;\r\n\r\n    // Other options\r\n    this.disableReadOnlyUsersAck = jsonData.disableReadOnlyUsersAck;\r\n\r\n    // Direct DB Connection options\r\n    let dbConnectionOptions = jsonData.dbConnection || {};\r\n    this.enableDirectDBConnection = dbConnectionOptions.enable;\r\n    this.sqlDatasourceId = dbConnectionOptions.datasourceId;\r\n\r\n    let zabbixOptions = {\r\n      username: this.username,\r\n      password: this.password,\r\n      basicAuth: this.basicAuth,\r\n      withCredentials: this.withCredentials,\r\n      cacheTTL: this.cacheTTL,\r\n      enableDirectDBConnection: this.enableDirectDBConnection,\r\n      sqlDatasourceId: this.sqlDatasourceId\r\n    };\r\n\r\n    this.zabbix = new Zabbix(this.url, zabbixOptions);\r\n  }\r\n\r\n  ////////////////////////\r\n  // Datasource methods //\r\n  ////////////////////////\r\n\r\n  /**\r\n   * Query panel data. Calls for each panel in dashboard.\r\n   * @param  {Object} options   Contains time range, targets and other info.\r\n   * @return {Object} Grafana metrics object with timeseries data for each target.\r\n   */\r\n  query(options) {\r\n    // Get alerts for current panel\r\n    if (this.alertingEnabled) {\r\n      this.alertQuery(options).then(alert => {\r\n        this.zabbixAlertingSrv.setPanelAlertState(options.panelId, alert.state);\r\n\r\n        this.zabbixAlertingSrv.removeZabbixThreshold(options.panelId);\r\n        if (this.addThresholds) {\r\n          _.forEach(alert.thresholds, threshold => {\r\n            this.zabbixAlertingSrv.setPanelThreshold(options.panelId, threshold);\r\n          });\r\n        }\r\n      });\r\n    }\r\n\r\n    // Create request for each target\r\n    let promises = _.map(options.targets, t => {\r\n      // Don't request undefined and hidden targets\r\n      if (t.hide) {\r\n        return [];\r\n      }\r\n\r\n      let timeFrom = Math.ceil(dateMath.parse(options.range.from) / 1000);\r\n      let timeTo = Math.ceil(dateMath.parse(options.range.to) / 1000);\r\n\r\n      // Prevent changes of original object\r\n      let target = _.cloneDeep(t);\r\n      this.replaceTargetVariables(target, options);\r\n\r\n      // Apply Time-related functions (timeShift(), etc)\r\n      let timeFunctions = bindFunctionDefs(target.functions, 'Time');\r\n      if (timeFunctions.length) {\r\n        const [time_from, time_to] = sequence(timeFunctions)([timeFrom, timeTo]);\r\n        timeFrom = time_from;\r\n        timeTo = time_to;\r\n      }\r\n      let timeRange = [timeFrom, timeTo];\r\n\r\n      let useTrends = this.isUseTrends(timeRange);\r\n\r\n      // Metrics or Text query mode\r\n      if (!target.mode || target.mode === c.MODE_METRICS || target.mode === c.MODE_TEXT) {\r\n        // Migrate old targets\r\n        target = migrations.migrate(target);\r\n\r\n        // Don't request undefined and hidden targets\r\n        if (target.hide || !target.group || !target.host || !target.item) {\r\n          return [];\r\n        }\r\n\r\n        if (!target.mode || target.mode === c.MODE_METRICS) {\r\n          return this.queryNumericData(target, timeRange, useTrends, options);\r\n        } else if (target.mode === c.MODE_TEXT) {\r\n          return this.queryTextData(target, timeRange);\r\n        }\r\n      } else if (target.mode === c.MODE_ITEMID) {\r\n        // Item ID mode\r\n        if (!target.itemids) {\r\n          return [];\r\n        }\r\n        return this.queryItemIdData(target, timeRange, useTrends, options);\r\n      } else if (target.mode === c.MODE_ITSERVICE) {\r\n        // IT services mode\r\n        return this.queryITServiceData(target, timeRange, options);\r\n      } else if (target.mode === c.MODE_TRIGGERS) {\r\n        // Triggers mode\r\n        return this.queryTriggersData(target, timeRange);\r\n      } else {\r\n        return [];\r\n      }\r\n    });\r\n\r\n    // Data for panel (all targets)\r\n    return Promise.all(_.flatten(promises))\r\n      .then(_.flatten)\r\n      .then(data => {\r\n        return { data: data };\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Query target data for Metrics mode\r\n   */\r\n  queryNumericData(target, timeRange, useTrends, options) {\r\n    let getItemOptions = {\r\n      itemtype: 'num'\r\n    };\r\n    return this.zabbix.getItemsFromTarget(target, getItemOptions)\r\n    .then(items => {\r\n      return this.queryNumericDataForItems(items, target, timeRange, useTrends, options);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Query history for numeric items\r\n   */\r\n  queryNumericDataForItems(items, target, timeRange, useTrends, options) {\r\n    let [timeFrom, timeTo] = timeRange;\r\n    let getHistoryPromise;\r\n    options.consolidateBy = getConsolidateBy(target);\r\n\r\n    if (useTrends) {\r\n      if (this.enableDirectDBConnection) {\r\n        getHistoryPromise = this.zabbix.getTrendsDB(items, timeFrom, timeTo, options)\r\n        .then(history => this.zabbix.dbConnector.handleGrafanaTSResponse(history, items));\r\n      } else {\r\n        let valueType = this.getTrendValueType(target);\r\n        getHistoryPromise = this.zabbix.getTrend(items, timeFrom, timeTo)\r\n        .then(history => responseHandler.handleTrends(history, items, valueType))\r\n        .then(timeseries => {\r\n          // Sort trend data, issue #202\r\n          _.forEach(timeseries, series => {\r\n            series.datapoints = _.sortBy(series.datapoints, point => point[c.DATAPOINT_TS]);\r\n          });\r\n          return timeseries;\r\n        });\r\n      }\r\n    } else {\r\n      // Use history\r\n      if (this.enableDirectDBConnection) {\r\n        getHistoryPromise = this.zabbix.getHistoryDB(items, timeFrom, timeTo, options)\r\n        .then(history => this.zabbix.dbConnector.handleGrafanaTSResponse(history, items));\r\n      } else {\r\n        getHistoryPromise = this.zabbix.getHistory(items, timeFrom, timeTo)\r\n        .then(history => responseHandler.handleHistory(history, items));\r\n      }\r\n    }\r\n\r\n    return getHistoryPromise\r\n    .then(timeseries => this.applyDataProcessingFunctions(timeseries, target))\r\n    .then(timeseries => downsampleSeries(timeseries, options));\r\n  }\r\n\r\n  getTrendValueType(target) {\r\n    // Find trendValue() function and get specified trend value\r\n    var trendFunctions = _.map(metricFunctions.getCategories()['Trends'], 'name');\r\n    var trendValueFunc = _.find(target.functions, func => {\r\n      return _.includes(trendFunctions, func.def.name);\r\n    });\r\n    return trendValueFunc ? trendValueFunc.params[0] : \"avg\";\r\n  }\r\n\r\n  applyDataProcessingFunctions(timeseries_data, target) {\r\n    let transformFunctions   = bindFunctionDefs(target.functions, 'Transform');\r\n    let aggregationFunctions = bindFunctionDefs(target.functions, 'Aggregate');\r\n    let filterFunctions      = bindFunctionDefs(target.functions, 'Filter');\r\n    let aliasFunctions       = bindFunctionDefs(target.functions, 'Alias');\r\n\r\n    // Apply transformation functions\r\n    timeseries_data = _.cloneDeep(_.map(timeseries_data, timeseries => {\r\n      timeseries.datapoints = sequence(transformFunctions)(timeseries.datapoints);\r\n      return timeseries;\r\n    }));\r\n\r\n    // Apply filter functions\r\n    if (filterFunctions.length) {\r\n      timeseries_data = sequence(filterFunctions)(timeseries_data);\r\n    }\r\n\r\n    // Apply aggregations\r\n    if (aggregationFunctions.length) {\r\n      let dp = _.map(timeseries_data, 'datapoints');\r\n      dp = sequence(aggregationFunctions)(dp);\r\n\r\n      let aggFuncNames = _.map(metricFunctions.getCategories()['Aggregate'], 'name');\r\n      let lastAgg = _.findLast(target.functions, func => {\r\n        return _.includes(aggFuncNames, func.def.name);\r\n      });\r\n\r\n      timeseries_data = [{\r\n        target: lastAgg.text,\r\n        datapoints: dp\r\n      }];\r\n    }\r\n\r\n    // Apply alias functions\r\n    _.forEach(timeseries_data, sequence(aliasFunctions));\r\n\r\n    // Apply Time-related functions (timeShift(), etc)\r\n    // Find timeShift() function and get specified trend value\r\n    this.applyTimeShiftFunction(timeseries_data, target);\r\n\r\n    return timeseries_data;\r\n  }\r\n\r\n  applyTimeShiftFunction(timeseries_data, target) {\r\n    // Find timeShift() function and get specified interval\r\n    let timeShiftFunc = _.find(target.functions, (func) => {\r\n      return func.def.name === 'timeShift';\r\n    });\r\n    if (timeShiftFunc) {\r\n      let shift = timeShiftFunc.params[0];\r\n      _.forEach(timeseries_data, (series) => {\r\n        series.datapoints = dataProcessor.unShiftTimeSeries(shift, series.datapoints);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query target data for Text mode\r\n   */\r\n  queryTextData(target, timeRange) {\r\n    let [timeFrom, timeTo] = timeRange;\r\n    let options = {\r\n      itemtype: 'text'\r\n    };\r\n    return this.zabbix.getItemsFromTarget(target, options)\r\n      .then(items => {\r\n        if (items.length) {\r\n          return this.zabbix.getHistory(items, timeFrom, timeTo)\r\n          .then(history => {\r\n            if (target.resultFormat === 'table') {\r\n              return responseHandler.handleHistoryAsTable(history, items, target);\r\n            } else {\r\n              return responseHandler.handleText(history, items, target);\r\n            }\r\n          });\r\n        } else {\r\n          return Promise.resolve([]);\r\n        }\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Query target data for Item ID mode\r\n   */\r\n  queryItemIdData(target, timeRange, useTrends, options) {\r\n    let itemids = target.itemids;\r\n    itemids = this.templateSrv.replace(itemids, options.scopedVars, zabbixItemIdsTemplateFormat);\r\n    itemids = _.map(itemids.split(','), itemid => itemid.trim());\r\n\r\n    if (!itemids) {\r\n      return [];\r\n    }\r\n\r\n    return this.zabbix.getItemsByIDs(itemids)\r\n    .then(items => {\r\n      return this.queryNumericDataForItems(items, target, timeRange, useTrends, options);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Query target data for IT Services mode\r\n   */\r\n  queryITServiceData(target, timeRange, options) {\r\n    // Don't show undefined and hidden targets\r\n    if (target.hide || (!target.itservice && !target.itServiceFilter) || !target.slaProperty) {\r\n      return [];\r\n    }\r\n\r\n    let itServiceIds = [];\r\n    let itServices = [];\r\n    let itServiceFilter;\r\n    let isOldVersion = target.itservice && !target.itServiceFilter;\r\n\r\n    if (isOldVersion) {\r\n      // Backward compatibility\r\n      itServiceFilter = '/.*/';\r\n    } else {\r\n      itServiceFilter = this.replaceTemplateVars(target.itServiceFilter, options.scopedVars);\r\n    }\r\n\r\n    return this.zabbix.getITServices(itServiceFilter)\r\n    .then(itservices => {\r\n      itServices = itservices;\r\n      if (isOldVersion) {\r\n        itServices = _.filter(itServices, {'serviceid': target.itservice.serviceid});\r\n      }\r\n\r\n      itServiceIds = _.map(itServices, 'serviceid');\r\n      return itServiceIds;\r\n    })\r\n    .then(serviceids => {\r\n      return this.zabbix.getSLA(serviceids, timeRange);\r\n    })\r\n    .then(slaResponse => {\r\n      return _.map(itServiceIds, serviceid => {\r\n        let itservice = _.find(itServices, {'serviceid': serviceid});\r\n        return responseHandler.handleSLAResponse(itservice, target.slaProperty, slaResponse);\r\n      });\r\n    });\r\n  }\r\n\r\n  queryTriggersData(target, timeRange) {\r\n    let [timeFrom, timeTo] = timeRange;\r\n    return this.zabbix.getHostsFromTarget(target)\r\n    .then((results) => {\r\n      let [hosts, apps] = results;\r\n      if (hosts.length) {\r\n        let hostids = _.map(hosts, 'hostid');\r\n        let appids = _.map(apps, 'applicationid');\r\n        let options = {\r\n          minSeverity: target.triggers.minSeverity,\r\n          acknowledged: target.triggers.acknowledged,\r\n          count: target.triggers.count,\r\n          timeFrom: timeFrom,\r\n          timeTo: timeTo\r\n        };\r\n        return this.zabbix.getHostAlerts(hostids, appids, options)\r\n        .then((triggers) => {\r\n          return responseHandler.handleTriggersResponse(triggers, timeRange);\r\n        });\r\n      } else {\r\n        return Promise.resolve([]);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Test connection to Zabbix API\r\n   * @return {object} Connection status and Zabbix API version\r\n   */\r\n  testDatasource() {\r\n    let zabbixVersion;\r\n    return this.zabbix.getVersion()\r\n    .then(version => {\r\n      zabbixVersion = version;\r\n      return this.zabbix.login();\r\n    })\r\n    .then(() => {\r\n      if (this.enableDirectDBConnection) {\r\n        return this.zabbix.dbConnector.testSQLDataSource();\r\n      } else {\r\n        return Promise.resolve();\r\n      }\r\n    })\r\n    .then(() => {\r\n      return {\r\n        status: \"success\",\r\n        title: \"Success\",\r\n        message: \"Zabbix API version: \" + zabbixVersion\r\n      };\r\n    })\r\n    .catch(error => {\r\n      if (error instanceof ZabbixAPIError) {\r\n        return {\r\n          status: \"error\",\r\n          title: error.message,\r\n          message: error.message\r\n        };\r\n      } else if (error.data && error.data.message) {\r\n        return {\r\n          status: \"error\",\r\n          title: \"Connection failed\",\r\n          message: \"Connection failed: \" + error.data.message\r\n        };\r\n      } else {\r\n        return {\r\n          status: \"error\",\r\n          title: \"Connection failed\",\r\n          message: \"Could not connect to given url\"\r\n        };\r\n      }\r\n    });\r\n  }\r\n\r\n  ////////////////\r\n  // Templating //\r\n  ////////////////\r\n\r\n  /**\r\n   * Find metrics from templated request.\r\n   *\r\n   * @param  {string} query Query from Templating\r\n   * @return {string}       Metric name - group, host, app or item or list\r\n   *                        of metrics in \"{metric1,metcic2,...,metricN}\" format.\r\n   */\r\n  metricFindQuery(query) {\r\n    let result;\r\n    let parts = [];\r\n\r\n    // Split query. Query structure: group.host.app.item\r\n    _.each(utils.splitTemplateQuery(query), part => {\r\n      part = this.replaceTemplateVars(part, {});\r\n\r\n      // Replace wildcard to regex\r\n      if (part === '*') {\r\n        part = '/.*/';\r\n      }\r\n      parts.push(part);\r\n    });\r\n    let template = _.zipObject(['group', 'host', 'app', 'item'], parts);\r\n\r\n    // Get items\r\n    if (parts.length === 4) {\r\n      // Search for all items, even it's not belong to any application\r\n      if (template.app === '/.*/') {\r\n        template.app = '';\r\n      }\r\n      result = this.zabbix.getItems(template.group, template.host, template.app, template.item);\r\n    } else if (parts.length === 3) {\r\n      // Get applications\r\n      result = this.zabbix.getApps(template.group, template.host, template.app);\r\n    } else if (parts.length === 2) {\r\n      // Get hosts\r\n      result = this.zabbix.getHosts(template.group, template.host);\r\n    } else if (parts.length === 1) {\r\n      // Get groups\r\n      result = this.zabbix.getGroups(template.group);\r\n    } else {\r\n      result = Promise.resolve([]);\r\n    }\r\n\r\n    return result.then(metrics => {\r\n      return _.map(metrics, formatMetric);\r\n    });\r\n  }\r\n\r\n  /////////////////\r\n  // Annotations //\r\n  /////////////////\r\n\r\n  annotationQuery(options) {\r\n    var timeFrom = Math.ceil(dateMath.parse(options.rangeRaw.from) / 1000);\r\n    var timeTo = Math.ceil(dateMath.parse(options.rangeRaw.to) / 1000);\r\n    var annotation = options.annotation;\r\n    var showOkEvents = annotation.showOkEvents ? c.SHOW_ALL_EVENTS : c.SHOW_OK_EVENTS;\r\n\r\n    // Show all triggers\r\n    let triggersOptions = {\r\n      showTriggers: c.SHOW_ALL_TRIGGERS,\r\n      hideHostsInMaintenance: false\r\n    };\r\n\r\n    var getTriggers = this.zabbix.getTriggers(this.replaceTemplateVars(annotation.group, {}),\r\n                                              this.replaceTemplateVars(annotation.host, {}),\r\n                                              this.replaceTemplateVars(annotation.application, {}),\r\n                                              triggersOptions);\r\n\r\n    return getTriggers.then(triggers => {\r\n\r\n      // Filter triggers by description\r\n      let triggerName = this.replaceTemplateVars(annotation.trigger, {});\r\n      if (utils.isRegex(triggerName)) {\r\n        triggers = _.filter(triggers, trigger => {\r\n          return utils.buildRegex(triggerName).test(trigger.description);\r\n        });\r\n      } else if (triggerName) {\r\n        triggers = _.filter(triggers, trigger => {\r\n          return trigger.description === triggerName;\r\n        });\r\n      }\r\n\r\n      // Remove events below the chose severity\r\n      triggers = _.filter(triggers, trigger => {\r\n        return Number(trigger.priority) >= Number(annotation.minseverity);\r\n      });\r\n\r\n      var objectids = _.map(triggers, 'triggerid');\r\n      return this.zabbix\r\n        .getEvents(objectids, timeFrom, timeTo, showOkEvents)\r\n        .then(events => {\r\n          var indexedTriggers = _.keyBy(triggers, 'triggerid');\r\n\r\n          // Hide acknowledged events if option enabled\r\n          if (annotation.hideAcknowledged) {\r\n            events = _.filter(events, event => {\r\n              return !event.acknowledges.length;\r\n            });\r\n          }\r\n\r\n          return _.map(events, event => {\r\n            let tags;\r\n            if (annotation.showHostname) {\r\n              tags = _.map(event.hosts, 'name');\r\n            }\r\n\r\n            // Show event type (OK or Problem)\r\n            let title = Number(event.value) ? 'Problem' : 'OK';\r\n\r\n            let formatted_acknowledges = utils.formatAcknowledges(event.acknowledges);\r\n            return {\r\n              annotation: annotation,\r\n              time: event.clock * 1000,\r\n              title: title,\r\n              tags: tags,\r\n              text: indexedTriggers[event.objectid].description + formatted_acknowledges\r\n            };\r\n          });\r\n        });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get triggers and its details for panel's targets\r\n   * Returns alert state ('ok' if no fired triggers, or 'alerting' if at least 1 trigger is fired)\r\n   * or empty object if no related triggers are finded.\r\n   */\r\n  alertQuery(options) {\r\n    let enabled_targets = filterEnabledTargets(options.targets);\r\n    let getPanelItems = _.map(enabled_targets, t => {\r\n      let target = _.cloneDeep(t);\r\n      this.replaceTargetVariables(target, options);\r\n      return this.zabbix.getItemsFromTarget(target, {itemtype: 'num'});\r\n    });\r\n\r\n    return Promise.all(getPanelItems)\r\n    .then(results => {\r\n      let items = _.flatten(results);\r\n      let itemids = _.map(items, 'itemid');\r\n\r\n      if (itemids.length === 0) {\r\n        return [];\r\n      }\r\n      return this.zabbix.getAlerts(itemids);\r\n    })\r\n    .then(triggers => {\r\n      triggers = _.filter(triggers, trigger => {\r\n        return trigger.priority >= this.alertingMinSeverity;\r\n      });\r\n\r\n      if (!triggers || triggers.length === 0) {\r\n        return {};\r\n      }\r\n\r\n      let state = 'ok';\r\n\r\n      let firedTriggers = _.filter(triggers, {value: '1'});\r\n      if (firedTriggers.length) {\r\n        state = 'alerting';\r\n      }\r\n\r\n      let thresholds = _.map(triggers, trigger => {\r\n        return getTriggerThreshold(trigger.expression);\r\n      });\r\n\r\n      return {\r\n        panelId: options.panelId,\r\n        state: state,\r\n        thresholds: thresholds\r\n      };\r\n    });\r\n  }\r\n\r\n  // Replace template variables\r\n  replaceTargetVariables(target, options) {\r\n    let parts = ['group', 'host', 'application', 'item'];\r\n    _.forEach(parts, p => {\r\n      if (target[p] && target[p].filter) {\r\n        target[p].filter = this.replaceTemplateVars(target[p].filter, options.scopedVars);\r\n      }\r\n    });\r\n    target.textFilter = this.replaceTemplateVars(target.textFilter, options.scopedVars);\r\n\r\n    _.forEach(target.functions, func => {\r\n      func.params = _.map(func.params, param => {\r\n        if (typeof param === 'number') {\r\n          return +this.templateSrv.replace(param.toString(), options.scopedVars);\r\n        } else {\r\n          return this.templateSrv.replace(param, options.scopedVars);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  isUseTrends(timeRange) {\r\n    let [timeFrom, timeTo] = timeRange;\r\n    let useTrendsFrom = Math.ceil(dateMath.parse('now-' + this.trendsFrom) / 1000);\r\n    let useTrendsRange = Math.ceil(utils.parseInterval(this.trendsRange) / 1000);\r\n    let useTrends = this.trends && (\r\n      (timeFrom <= useTrendsFrom) ||\r\n      (timeTo - timeFrom >= useTrendsRange)\r\n    );\r\n    return useTrends;\r\n  }\r\n}\r\n\r\nfunction bindFunctionDefs(functionDefs, category) {\r\n  var aggregationFunctions = _.map(metricFunctions.getCategories()[category], 'name');\r\n  var aggFuncDefs = _.filter(functionDefs, function(func) {\r\n    return _.includes(aggregationFunctions, func.def.name);\r\n  });\r\n\r\n  return _.map(aggFuncDefs, function(func) {\r\n    var funcInstance = metricFunctions.createFuncInstance(func.def, func.params);\r\n    return funcInstance.bindFunction(dataProcessor.metricFunctions);\r\n  });\r\n}\r\n\r\nfunction getConsolidateBy(target) {\r\n  let consolidateBy = 'avg';\r\n  let funcDef = _.find(target.functions, func => {\r\n    return func.def.name === 'consolidateBy';\r\n  });\r\n  if (funcDef && funcDef.params && funcDef.params.length) {\r\n    consolidateBy = funcDef.params[0];\r\n  }\r\n  return consolidateBy;\r\n}\r\n\r\nfunction downsampleSeries(timeseries_data, options) {\r\n  let defaultAgg = dataProcessor.aggregationFunctions['avg'];\r\n  let consolidateByFunc = dataProcessor.aggregationFunctions[options.consolidateBy] || defaultAgg;\r\n  return _.map(timeseries_data, timeseries => {\r\n    if (timeseries.datapoints.length > options.maxDataPoints) {\r\n      timeseries.datapoints = dataProcessor\r\n        .groupBy(options.interval, consolidateByFunc, timeseries.datapoints);\r\n    }\r\n    return timeseries;\r\n  });\r\n}\r\n\r\nfunction formatMetric(metricObj) {\r\n  return {\r\n    text: metricObj.name,\r\n    expandable: false\r\n  };\r\n}\r\n\r\n/**\r\n * Custom formatter for template variables.\r\n * Default Grafana \"regex\" formatter returns\r\n * value1|value2\r\n * This formatter returns\r\n * (value1|value2)\r\n * This format needed for using in complex regex with\r\n * template variables, for example\r\n * /CPU $cpu_item.*time/ where $cpu_item is system,user,iowait\r\n */\r\nfunction zabbixTemplateFormat(value) {\r\n  if (typeof value === 'string') {\r\n    return utils.escapeRegex(value);\r\n  }\r\n\r\n  var escapedValues = _.map(value, utils.escapeRegex);\r\n  return '(' + escapedValues.join('|') + ')';\r\n}\r\n\r\nfunction zabbixItemIdsTemplateFormat(value) {\r\n  if (typeof value === 'string') {\r\n    return value;\r\n  }\r\n  return value.join(',');\r\n}\r\n\r\n/**\r\n * If template variables are used in request, replace it using regex format\r\n * and wrap with '/' for proper multi-value work. Example:\r\n * $variable selected as a, b, c\r\n * We use filter $variable\r\n * $variable    -> a|b|c    -> /a|b|c/\r\n * /$variable/  -> /a|b|c/  -> /a|b|c/\r\n */\r\nfunction replaceTemplateVars(templateSrv, target, scopedVars) {\r\n  var replacedTarget = templateSrv.replace(target, scopedVars, zabbixTemplateFormat);\r\n  if (target !== replacedTarget && !utils.isRegex(replacedTarget)) {\r\n    replacedTarget = '/^' + replacedTarget + '$/';\r\n  }\r\n  return replacedTarget;\r\n}\r\n\r\n// Apply function one by one:\r\n// sequence([a(), b(), c()]) = c(b(a()));\r\nfunction sequence(funcsArray) {\r\n  return function(result) {\r\n    for (var i = 0; i < funcsArray.length; i++) {\r\n      result = funcsArray[i].call(this, result);\r\n    }\r\n    return result;\r\n  };\r\n}\r\n\r\nfunction filterEnabledTargets(targets) {\r\n  return _.filter(targets, target => {\r\n    return !(target.hide || !target.group || !target.host || !target.item);\r\n  });\r\n}\r\n\r\nfunction getTriggerThreshold(expression) {\r\n  let thresholdPattern = /.*[<>=]{1,2}([\\d\\.]+)/;\r\n  let finded_thresholds = expression.match(thresholdPattern);\r\n  if (finded_thresholds && finded_thresholds.length >= 2) {\r\n    let threshold = finded_thresholds[1];\r\n    threshold = Number(threshold);\r\n    return threshold;\r\n  } else {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport {ZabbixAPIDatasource, zabbixTemplateFormat};\r\n\r\n// Fix for backward compatibility with lodash 2.4\r\nif (!_.includes) {_.includes = _.contains;}\r\nif (!_.keyBy) {_.keyBy = _.indexBy;}\r\n"]}